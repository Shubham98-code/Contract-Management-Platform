<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Update Contract</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Animated Background (Green/Teal Tint for Contracts) */
        .bg-animated {
            background: linear-gradient(-45deg, #8ae8a6, #6be8ae, #81bae1, #8ab2da);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Status Animations */
        @keyframes pulse-ring {
            0% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
            100% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }
        .status-active-icon {
            animation: pulse-ring 2s infinite;
        }
    </style>
</head>
<body class="bg-animated min-h-screen text-slate-800 selection:bg-emerald-200 selection:text-emerald-900">
    
    <div class="max-w-6xl mx-auto px-4 py-10">
        
        <a href="index.html" class="inline-flex items-center text-slate-500 hover:text-emerald-600 mb-8 transition-all duration-300 group font-medium">
            <div class="w-8 h-8 rounded-full bg-white shadow-sm flex items-center justify-center mr-3 group-hover:scale-110 group-hover:shadow-md transition-all">
                <svg class="w-4 h-4 transform group-hover:-translate-x-0.5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
            </div>
            Back to Dashboard
        </a>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 animate-fade-in">
            
            <div class="lg:col-span-2 space-y-6">
                
                <div>
                    <h1 class="text-4xl font-extrabold mb-2 tracking-tight">
                        <span class="bg-clip-text text-transparent bg-gradient-to-r from-emerald-600 to-teal-600 drop-shadow-sm">
                            Edit Contract Data
                        </span>
                    </h1>
                    <p class="text-slate-500 font-medium flex items-center gap-2">
                        <span id="contract-name">Loading...</span>
                        <span class="px-2 py-0.5 rounded-md bg-emerald-100 text-emerald-700 text-xs font-bold uppercase tracking-wider border border-emerald-200" id="status-badge-small">...</span>
                    </p>
                </div>

                <div class="bg-white/80 backdrop-blur-xl rounded-2xl shadow-xl shadow-emerald-900/5 border border-white/50 overflow-hidden transition-all hover:shadow-2xl hover:shadow-emerald-500/10">
                    <div class="p-8">
                        <form id="update-form" class="space-y-6" onsubmit="event.preventDefault(); saveChanges();">
                            <div id="fields-container" class="space-y-6 min-h-[100px]">
                                </div>

                            <div class="pt-8 border-t border-slate-200/60 mt-8">
                                <button type="submit" class="w-full bg-gradient-to-r from-emerald-500 to-teal-600 hover:from-emerald-600 hover:to-teal-700 text-white py-4 rounded-xl font-bold shadow-lg shadow-emerald-500/20 transition-all duration-300 hover:scale-[1.01] active:scale-[0.99] flex justify-center items-center gap-2 group">
                                    <svg class="w-5 h-5 text-emerald-100 group-hover:text-white transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/></svg>
                                    Save Field Changes
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="space-y-6">
                <div class="bg-white/90 backdrop-blur-xl rounded-2xl shadow-xl shadow-slate-200/50 border border-white/50 p-6 sticky top-6 transition-all">
                    
                    <h3 class="font-bold text-slate-800 mb-6 pb-4 border-b border-slate-100 flex items-center gap-2">
                        <span class="text-xl">üîÑ</span> Contract Lifecycle
                    </h3>
                    
                    <div id="lifecycle-list" class="space-y-0 relative pl-2">
                        <div class="absolute left-[23px] top-4 bottom-10 w-0.5 bg-slate-200 -z-10"></div>
                        </div>

                    <div class="mt-8 pt-6 border-t border-slate-100">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                            <span class="w-1.5 h-1.5 rounded-full bg-red-400"></span> Danger Zone
                        </p>
                        <div class="space-y-3">
                             <button id="revoke-btn" onclick="changeStatus('Revoked')" class="w-full text-orange-600 bg-orange-50 border border-orange-100 hover:bg-orange-100 hover:border-orange-200 font-bold text-sm py-3 rounded-xl transition-all duration-200 flex items-center justify-center gap-2 group">
                                <svg class="w-4 h-4 opacity-70 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                                Revoke Contract
                            </button>
                            <button onclick="deleteContract()" class="w-full text-red-600 bg-red-50 border border-red-100 hover:bg-red-100 hover:border-red-200 font-bold text-sm py-3 rounded-xl transition-all duration-200 flex items-center justify-center gap-2 group">
                                <svg class="w-4 h-4 opacity-70 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                                Delete Contract
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="script.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const id = urlParams.get('id');
        const contracts = DB.get("contracts");
        const contract = contracts.find(c => c.id == id);

        if (!contract) {
            alert("Contract not found!");
            window.location.href = "index.html";
        }

        // Render Header Info
        document.getElementById('contract-name').innerText = contract.clientName || ('Contract #' + contract.id);
        document.getElementById('status-badge-small').innerText = contract.status;

        // Render Fields
        const container = document.getElementById('fields-container');
        const isLocked = contract.status === 'Locked' || contract.status === 'Revoked';

        container.innerHTML = contract.fields.map((f, idx) => {
            // Check if this is a signature field
            if (f.type === 'signature') {
                const hasValue = f.value && f.value.length > 0;
                return `
                <div class="group p-5 border border-slate-200 rounded-xl bg-slate-50/50 hover:bg-white hover:border-emerald-200 hover:shadow-md transition-all duration-300">
                    <label class="block text-sm font-bold text-slate-700 mb-3 flex items-center gap-2">
                        <svg class="w-4 h-4 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                        ${f.label} <span class="text-xs font-normal text-emerald-600 bg-emerald-100 px-2 py-0.5 rounded-full">Image Upload</span>
                    </label>
                    
                    <div class="mb-4 ${hasValue ? '' : 'hidden'} transition-all" id="preview-container-${idx}">
                        <div class="relative inline-block group/img">
                            <img id="preview-${idx}" src="${f.value}" class="h-24 border-2 border-emerald-100 rounded-lg bg-white p-2 shadow-sm">
                            <div class="absolute inset-0 bg-black/5 opacity-0 group-hover/img:opacity-100 transition-opacity rounded-lg"></div>
                        </div>
                    </div>

                    <label class="block">
                        <span class="sr-only">Choose file</span>
                        <input type="file" accept="image/*" 
                            onchange="handleFileUpload(this, ${idx})"
                            ${isLocked ? 'disabled' : ''}
                            class="block w-full text-sm text-slate-500
                                file:mr-4 file:py-2.5 file:px-4
                                file:rounded-full file:border-0
                                file:text-sm file:font-semibold
                                file:bg-emerald-50 file:text-emerald-700
                                hover:file:bg-emerald-100
                                transition-all cursor-pointer disabled:opacity-50 disabled:cursor-not-allowed
                            "/>
                    </label>
                    
                    <input type="hidden" id="field-${idx}" value="${f.value || ''}">
                </div>`;
            } else {
                // Standard Text/Date Input
                return `
                <div class="group">
                    <label class="block text-sm font-bold text-slate-700 mb-2 ml-1 transition-colors group-focus-within:text-emerald-600">${f.label}</label>
                    <input type="${f.type}" id="field-${idx}" value="${f.value || ''}" 
                        ${isLocked ? 'disabled' : ''}
                        class="w-full px-4 py-3 rounded-xl border border-slate-200 bg-slate-50/30 focus:bg-white focus:border-emerald-500 focus:ring-4 focus:ring-emerald-500/10 transition-all outline-none font-medium disabled:bg-slate-100 disabled:text-slate-400 disabled:cursor-not-allowed">
                </div>`;
            }
        }).join("");

        if(isLocked) {
            document.querySelector('button[type="submit"]').style.display = 'none';
            const form = document.getElementById('update-form');
            form.classList.add('opacity-75', 'pointer-events-none');
        }

        renderLifecycleList();

        function handleFileUpload(input, idx) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById(`field-${idx}`).value = e.target.result;
                    const preview = document.getElementById(`preview-${idx}`);
                    const container = document.getElementById(`preview-container-${idx}`);
                    preview.src = e.target.result;
                    container.classList.remove('hidden');
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function renderLifecycleList() {
            const listContainer = document.getElementById('lifecycle-list');
            const steps = [
                { status: 'Created', label: 'Draft Created', icon: 'üìù' },
                { status: 'Approved', label: 'Approve Contract', icon: '‚úÖ' },
                { status: 'Sent', label: 'Send to Client', icon: 'üì®' },
                { status: 'Signed', label: 'Mark as Signed', icon: '‚úçÔ∏è' },
                { status: 'Locked', label: 'Lock Contract', icon: 'üîí' }
            ];

            if(contract.status === 'Revoked') {
                listContainer.innerHTML = `<div class="p-4 rounded-xl bg-red-50 border border-red-200 text-red-700 font-bold flex items-center gap-3 animate-fade-in"><span class="w-8 h-8 rounded-full bg-red-200 flex items-center justify-center text-lg shadow-sm">üö´</span>Contract Revoked</div>`;
                document.getElementById('revoke-btn').style.display = 'none';
                return;
            }

            let currentIndex = steps.findIndex(s => s.status === contract.status);

            listContainer.innerHTML = steps.map((step, index) => {
                let stateClass = "";
                let iconDisplay = "";
                let clickAction = "";

                if (index <= currentIndex) {
                    // COMPLETED
                    stateClass = "bg-white border-slate-100 opacity-80";
                    iconDisplay = `<div class="w-8 h-8 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center border border-emerald-200 shadow-sm z-10"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/></svg></div>`;
                    
                    if(index === currentIndex && contract.status === 'Locked') {
                        iconDisplay = `<div class="w-8 h-8 rounded-full bg-slate-800 text-white flex items-center justify-center shadow-lg z-10">üîí</div>`;
                        stateClass = "bg-slate-100 border-slate-200 font-bold shadow-inner";
                    }
                } else if (index === currentIndex + 1) {
                    // NEXT ACTION (Active)
                    stateClass = "bg-emerald-50/80 border-emerald-200 shadow-md transform scale-[1.02] cursor-pointer hover:bg-emerald-100 hover:shadow-lg transition-all z-10";
                    iconDisplay = `<div class="w-10 h-10 rounded-full bg-gradient-to-br from-emerald-500 to-teal-600 text-white flex items-center justify-center shadow-lg shadow-emerald-500/30 status-active-icon z-20 text-lg">${step.icon}</div>`;
                    clickAction = `onclick="changeStatus('${step.status}')"`;
                } else {
                    // FUTURE
                    stateClass = "bg-transparent border-transparent text-slate-400 opacity-60";
                    iconDisplay = `<div class="w-8 h-8 rounded-full bg-slate-100 text-slate-400 border border-slate-200 flex items-center justify-center font-bold text-xs z-10">${index + 1}</div>`;
                }

                const paddingClass = index === currentIndex + 1 ? "py-4 -ml-2" : "py-3";

                return `
                <div ${clickAction} class="relative flex items-center gap-4 ${paddingClass} rounded-xl border ${stateClass} px-4 transition-all duration-300 mb-2 select-none group">
                    ${iconDisplay}
                    <div class="flex-1">
                        <p class="font-bold text-sm ${index === currentIndex + 1 ? 'text-emerald-700' : ''}">${step.label}</p>
                        ${index === currentIndex + 1 ? '<p class="text-[10px] text-emerald-600 font-bold uppercase tracking-wider mt-0.5 group-hover:underline">Click to Proceed ‚Üí</p>' : ''}
                    </div>
                </div>`;
            }).join("");
        }

        function saveChanges() {
            const inputs = document.querySelectorAll('input[id^="field-"]');
            inputs.forEach((input, idx) => contract.fields[idx].value = input.value);
            saveToDB();
            
            const btn = document.querySelector('button[type="submit"]');
            const original = btn.innerHTML;
            btn.innerHTML = `<span class="flex items-center gap-2">‚úì Saved!</span>`;
            
            setTimeout(() => {
                btn.innerHTML = original;
            }, 1500);
        }

        function changeStatus(newStatus) {
            const inputs = document.querySelectorAll('input[id^="field-"]');
            inputs.forEach((input, idx) => contract.fields[idx].value = input.value);
            contract.status = newStatus;
            saveToDB();
            window.location.reload();
        }

        function deleteContract() {
            if(confirm("Are you sure you want to PERMANENTLY delete this contract?")) {
                let allContracts = DB.get("contracts");
                allContracts = allContracts.filter(c => c.id != id);
                DB.set("contracts", allContracts);
                window.location.href = "index.html";
            }
        }

        function saveToDB() {
            const allContracts = DB.get("contracts");
            const dbIndex = allContracts.findIndex(c => c.id == id);
            if(dbIndex !== -1) {
                allContracts[dbIndex] = contract;
                DB.set("contracts", allContracts);
            }
        }
    </script>
</body>
</html>
